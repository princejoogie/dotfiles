#!/bin/bash

# Run all pending migrations to bring the system in line with the installed version.

KOJARCHY_PATH="${KOJARCHY_PATH:-$HOME/dotfiles}"
STATE_DIR="$HOME/.local/state/kojarchy/migrations"
mkdir -p "$STATE_DIR"
mkdir -p "$STATE_DIR/skipped"

for file in "$KOJARCHY_PATH"/migrations/*.sh; do
  [[ -f "$file" ]] || continue
  filename=$(basename "$file")

  if [[ ! -f "$STATE_DIR/$filename" && ! -f "$STATE_DIR/skipped/$filename" ]]; then
    echo -e "\e[32m\nRunning migration (${filename%.sh})\e[0m"

    if bash "$file"; then
      touch "$STATE_DIR/$filename"
    else
      if command -v gum &>/dev/null && gum confirm "Migration ${filename%.sh} failed. Skip and continue?"; then
        touch "$STATE_DIR/skipped/$filename"
      else
        exit 1
      fi
    fi
  fi
done
