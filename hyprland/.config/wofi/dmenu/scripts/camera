#!/usr/bin/env bash

device=$(v4l2-ctl --list-devices | grep -E '/dev/video[0-9]+' | head -n1 | xargs)

if [ -z "$device" ]; then
    notify-send "Camera" "No video devices found"
    exit 1
fi

# Check if camera is in use
pids=$(fuser "$device" 2>/dev/null | tr -d '\n' | sed 's/.*: *//')

if [ -n "$pids" ]; then
    apps=""
    for pid in $pids; do
        # Skip non-numeric PIDs (like 'm' suffix from fuser)
        if [[ "$pid" =~ ^[0-9]+$ ]]; then
            app_info=$(ps axl | grep "^ *[^ ]* *[^ ]* *$pid " | grep -v grep)
            if [ -n "$app_info" ]; then
                app_name=$(echo "$app_info" | awk '{print $NF}' | sed 's|.*/||')
                apps="$apps$app_name (PID: $pid)\n"
            fi
        fi
    done
    
    if [ -n "$apps" ]; then
        notify-send "Camera" "Camera is in use by:\n$apps"
        exit 1
    fi
fi

DISPLAY=:0 ffplay -f v4l2 -i "$device" -window_title "Camera"
