#!/usr/bin/env bash

set -euo pipefail

notify() {
    if command -v notify-send >/dev/null; then
        notify-send "kill-process" "$1"
    fi
}

exclude=(
    qbittorrent-nox
)

exclude_re=""
if [ ${#exclude[@]} -gt 0 ]; then
    exclude_re=$(IFS='|'; printf '%s' "${exclude[*]}")
fi

raw=$(ps -u "$USER" -o pid=,comm= | awk -v exclude_re="$exclude_re" '
    exclude_re != "" && $2 ~ ("^(" exclude_re ")$") { next }
    !seen[$2]++ {
        printf "%s\t%s\n", $2, $1
    }
')

list=$(printf "%s\n" "$raw" | sort -t $'\t' -k1,1 | awk -F '\t' '
    {
        n++
        procs[n]=$1
        pids[n]=$2
        if (length($1) > maxlen) {
            maxlen=length($1)
        }
    }
    END {
        for (i = 1; i <= n; i++) {
            printf "%-*s %s\n", maxlen, procs[i], pids[i]
        }
    }
')

if [ -z "$list" ]; then
    notify "No processes found"
    exit 0
fi

selected=$(printf "%s\n" "$list" | wofi --dmenu --prompt "Kill process" --matching fuzzy)
if [ -z "$selected" ]; then
    exit 0
fi

proc=$(printf "%s\n" "$selected" | awk '{print $1}')
pid=$(printf "%s\n" "$selected" | awk '{print $NF}')
if [ -z "$pid" ]; then
    exit 0
fi

kill -9 "$pid"
notify "Killed $proc: $pid"
