#!/usr/bin/env bash

set -euo pipefail

if ! command -v ss >/dev/null; then
    echo "ss is required" >&2
    exit 1
fi

notify() {
    if command -v notify-send >/dev/null; then
        notify-send "kill-port" "$1"
    fi
}

exclude=(
    qbittorrent-nox
)

exclude_re=""
if [ ${#exclude[@]} -gt 0 ]; then
    exclude_re=$(IFS='|'; printf '%s' "${exclude[*]}")
fi

raw=$(ss -ltnpH 2>/dev/null | awk -v exclude_re="$exclude_re" '
    /pid=[0-9]+/ {
        local=$4
        port=local
        sub(/.*:/, "", port)
        pid=""
        if (match($0, /pid=[0-9]+/)) {
            pid=substr($0, RSTART+4, RLENGTH-4)
        }
        proc=$0
        sub(/.*users:\(\("/, "", proc)
        sub(/",pid=.*/, "", proc)
        if (exclude_re != "" && proc ~ ("^(" exclude_re ")$")) {
            next
        }
        if (pid != "" && port != "") {
            printf "%s\t%s\t%s\n", proc, port, pid
        }
    }
')

list=$(printf "%s\n" "$raw" | sort -t $'\t' -k2,2n | awk -F '\t' '
    {
        n++
        procs[n]=$1
        ports[n]=$2
        pids[n]=$3
        if (length($1) > maxlen) {
            maxlen=length($1)
        }
        if (length($2) > maxport) {
            maxport=length($2)
        }
    }
    END {
        for (i = 1; i <= n; i++) {
            printf "%-*s :%-*s %s\n", maxlen, procs[i], maxport, ports[i], pids[i]
        }
    }
')

if [ -z "$list" ]; then
    notify "No listening ports found"
    exit 0
fi

selected=$(printf "%s\n" "$list" | wofi --dmenu --prompt "Kill port" --matching fuzzy)
if [ -z "$selected" ]; then
    exit 0
fi

proc=$(printf "%s\n" "$selected" | awk '{print $1}')
pid=$(printf "%s\n" "$selected" | awk '{print $NF}')
if [ -z "$pid" ]; then
    exit 0
fi

kill "$pid"
notify "Killed $proc: $pid"
