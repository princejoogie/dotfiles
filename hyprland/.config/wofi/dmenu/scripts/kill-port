#!/usr/bin/env bash

set -euo pipefail

if ! command -v ss >/dev/null; then
    echo "ss is required" >&2
    exit 1
fi

list=$(ss -ltnpH 2>/dev/null | awk '
    /pid=[0-9]+/ {
        local=$4
        port=local
        sub(/.*:/, "", port)
        pid=""
        if (match($0, /pid=[0-9]+/)) {
            pid=substr($0, RSTART+4, RLENGTH-4)
        }
        proc=$0
        sub(/.*users:\(\("/, "", proc)
        sub(/",pid=.*/, "", proc)
        if (pid != "" && port != "") {
            printf "%s\t%s\t%s\t%s\n", pid, port, proc, local
        }
    }
')

if [ -z "$list" ]; then
    exit 0
fi

selected=$(printf "%s\n" "$list" | column -t -s $'\t' | wofi --dmenu --prompt "Kill port")
if [ -z "$selected" ]; then
    exit 0
fi

pid=$(printf "%s\n" "$selected" | awk '{print $1}')
if [ -z "$pid" ]; then
    exit 0
fi

kill "$pid"
