#!/usr/bin/env bash

set -euo pipefail

if ! command -v lsof >/dev/null; then
    echo "lsof is required" >&2
    exit 1
fi

list=$(lsof -nP -iTCP -sTCP:LISTEN 2>/dev/null | awk 'NR>1 {
    cmd=$1
    pid=$2
    addr=$(NF-1)
    port=addr
    sub(/.*:/, "", port)
    printf "%s\t%s\t%s\t%s\n", pid, port, cmd, addr
}')

if [ -z "$list" ]; then
    exit 0
fi

selected=$(printf "%s\n" "$list" | column -t -s $'\t' | wofi --dmenu --prompt "Kill port")
if [ -z "$selected" ]; then
    exit 0
fi

pid=$(printf "%s\n" "$selected" | awk '{print $1}')
if [ -z "$pid" ]; then
    exit 0
fi

kill "$pid"
